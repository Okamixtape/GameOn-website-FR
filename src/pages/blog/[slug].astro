---
import Layout from '../../layouts/Layout.astro';
import ArticleCard from '../../components/blog/ArticleCard.astro';
import { getCollection, type CollectionEntry } from 'astro:content';
import { formatDate } from '../../utils/date';
import { BLOG_CONFIG } from '../../constants/blog';

export async function getStaticPaths() {
  const blogEntries = await getCollection('blog', ({ data }: CollectionEntry<'blog'>) => {
    return data.draft !== true;
  });
  
  return blogEntries.map((entry: CollectionEntry<'blog'>) => ({
    params: { slug: entry.slug },
    props: { entry },
  }));
}

interface Props {
  entry: CollectionEntry<'blog'>;
}

const { entry } = Astro.props;
const { Content } = await entry.render();

// Articles similaires (même tags)
const allPosts = await getCollection('blog', ({ data }: CollectionEntry<'blog'>) => {
  return data.draft !== true;
});

const relatedPosts = allPosts
  .filter((post: CollectionEntry<'blog'>) => 
    post.slug !== entry.slug && 
    post.data.tags.some((tag: string) => entry.data.tags.includes(tag))
  )
  .slice(0, BLOG_CONFIG.MAX_RELATED_POSTS);
---

<Layout 
  title={`${entry.data.title} - Blog PIXEL CLASH`}
  description={entry.data.description}
  image={entry.data.image.url}
  type="article"
>
  <!-- Hero Article Immersif -->
  <section class="relative bg-gradient-to-br from-retro-pink via-retro-purple to-retro-blue text-white py-16 md:py-20 overflow-hidden">
    <!-- Pattern retro background -->
    <div class="absolute inset-0 opacity-10" style="background-image: repeating-linear-gradient(45deg, transparent, transparent 10px, rgba(255,0,110,.2) 10px, rgba(255,0,110,.2) 20px);"></div>
    
    <div class="container mx-auto px-4 relative z-10">
      <!-- Breadcrumb -->
      <nav class="mb-8 text-sm text-white/80">
        <a href="/" class="hover:text-white transition-colors">Accueil</a>
        <span class="mx-2">→</span>
        <a href="/blog" class="hover:text-white transition-colors">Blog</a>
        <span class="mx-2">→</span>
        <span class="text-white font-medium">{entry.data.title}</span>
      </nav>

      <div class="max-w-4xl mx-auto">
        <!-- Tags -->
        <div class="flex flex-wrap gap-2 mb-6">
          {entry.data.tags.map((tag: string) => (
            <a 
              href={`/blog/tags/${tag}`}
              class="text-sm bg-white/20 backdrop-blur-sm border border-white/30 px-3 py-1 rounded-full hover:bg-white/30 transition-colors"
            >
              #{tag}
            </a>
          ))}
        </div>
        
        <!-- Title -->
        <h1 class="font-gaming text-4xl md:text-5xl lg:text-6xl font-bold mb-6 leading-tight uppercase tracking-wide drop-shadow-[0_0_30px_rgba(0,217,255,0.8)]">
          {entry.data.title}
        </h1>
        
        <!-- Meta -->
        <div class="flex items-center gap-4 text-white/90 mb-8">
          <span class="font-medium">{entry.data.author}</span>
          <span>•</span>
          <time datetime={entry.data.pubDate.toISOString()}>
            {formatDate(entry.data.pubDate)}
          </time>
          {entry.data.updatedDate && (
            <>
              <span>•</span>
              <span class="text-sm">
                Mis à jour le {formatDate(entry.data.updatedDate)}
              </span>
            </>
          )}
        </div>
      </div>
    </div>
  </section>

  <!-- Featured Image Full Width -->
  <div class="relative -mt-16 mb-16">
    <div class="container mx-auto px-4">
      <div class="max-w-5xl mx-auto">
        <div class="aspect-video rounded-xl overflow-hidden shadow-2xl shadow-retro-purple/30 border-4 border-white">
          <picture>
            <source 
              srcset={entry.data.image.url.replace('.jpg', '.webp')} 
              type="image/webp"
            />
            <img 
              src={entry.data.image.url} 
              alt={entry.data.image.alt}
              class="w-full h-full object-cover"
              width="1920"
              height="1080"
              loading="eager"
              fetchpriority="high"
              decoding="async"
            />
          </picture>
        </div>
      </div>
    </div>
  </div>

  <article class="container mx-auto px-4 pb-16 max-w-4xl">

    <!-- Content -->
    <div class="prose prose-lg prose-zinc max-w-none
      prose-headings:font-gaming prose-headings:uppercase prose-headings:tracking-wide
      prose-h2:text-3xl prose-h2:mt-12 prose-h2:mb-6
      prose-h3:text-2xl prose-h3:mt-8 prose-h3:mb-4
      prose-p:leading-relaxed prose-p:text-zinc-700
      prose-a:text-retro-blue prose-a:no-underline hover:prose-a:underline
      prose-strong:text-retro-purple prose-strong:font-bold
      prose-ul:list-disc prose-ul:pl-6
      prose-ol:list-decimal prose-ol:pl-6
      prose-li:text-zinc-700
      prose-blockquote:border-l-4 prose-blockquote:border-retro-blue prose-blockquote:pl-4 prose-blockquote:italic
      prose-code:bg-zinc-100 prose-code:px-1 prose-code:py-0.5 prose-code:rounded prose-code:text-retro-purple
      prose-img:rounded-lg prose-img:shadow-lg
    ">
      <Content />
    </div>

    <!-- CTA Inscription -->
    <section class="mt-16 text-center bg-gradient-to-r from-retro-purple via-retro-blue to-retro-purple p-12 rounded-lg text-white shadow-lg shadow-retro-blue/30">
      <h2 class="font-gaming text-3xl font-bold mb-4 uppercase tracking-wide">Rejoignez l'Aventure !</h2>
      <p class="text-xl mb-8 opacity-90">
        Inscrivez-vous au PIXEL CLASH Championship 2026 et faites partie de l'histoire.
      </p>
      <div class="flex flex-wrap gap-4 justify-center">
        <button 
          data-open-modal
          class="inline-flex items-center gap-2 px-8 py-4 bg-white text-retro-purple font-bold rounded-lg hover:scale-105 transition-all duration-300 shadow-lg"
        >
          <span>Je m'inscris maintenant</span>
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"/>
          </svg>
        </button>
        <a 
          href="/details"
          class="inline-flex items-center gap-2 px-8 py-4 bg-white/10 backdrop-blur-sm border-2 border-white/30 hover:bg-white/20 hover:border-white/50 text-white font-bold rounded-lg transition-all duration-300"
        >
          <span>Voir les détails</span>
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"/>
          </svg>
        </a>
      </div>
      <p class="mt-4 text-sm opacity-75">
        Inscription gratuite • Confirmation immédiate par email
      </p>
    </section>

    <!-- Articles Similaires -->
    {relatedPosts.length > 0 && (
      <section class="mt-16">
        <h2 class="font-gaming text-3xl font-bold mb-8 uppercase">Articles Similaires</h2>
        
        <div class="grid md:grid-cols-3 gap-6">
          {relatedPosts.map((post: CollectionEntry<'blog'>) => (
            <ArticleCard post={post} variant="default" maxTags={0} />
          ))}
        </div>
      </section>
    )}

  </article>
</Layout>

<script>
  // Ouvrir le modal d'inscription
  const modalButton = document.querySelector('[data-open-modal]');
  if (modalButton) {
    modalButton.addEventListener('click', () => {
      const modal = document.getElementById('registration-modal');
      if (modal) {
        modal.classList.remove('hidden');
      }
    });
  }
</script>
