---
/**
 * Blog Redesign - Article Detail
 * 
 * Page de détail d'un article avec :
 * - Markdown rendering (prose)
 * - Metadata (auteur, date, temps lecture)
 * - Tags
 * - Related articles
 * - 100% Astro pur (0 KB JS)
 */

import { getCollection } from 'astro:content';
import type { CollectionEntry } from 'astro:content';
import LayoutRedesign from '../../layouts/LayoutRedesign.astro';
import { GridBackground } from '../../components/redesign/layout/GridBackground';
import Header from '../../components/redesign/layout/Header';
import Footer from '../../components/redesign/layout/Footer.astro';
import { Calendar, Clock, User, Tag, ArrowLeft, ArrowRight } from 'lucide-react';

export async function getStaticPaths() {
  const posts = await getCollection('blog-redesign', ({ data }) => {
    return data.draft !== true;
  });
  
  return posts.map((post) => ({
    params: { slug: post.slug },
    props: { post },
  }));
}

interface Props {
  post: CollectionEntry<'blog-redesign'>;
}

const { post } = Astro.props;
const { Content } = await post.render();

// Formater date
const formatDate = (date: Date) => {
  return new Intl.DateTimeFormat('fr-FR', {
    year: 'numeric',
    month: 'long',
    day: 'numeric'
  }).format(date);
};

// Related articles (même tags)
const allPosts = await getCollection('blog-redesign', ({ data }) => {
  return data.draft !== true;
});

const relatedPosts = allPosts
  .filter(p => p.slug !== post.slug)
  .filter(p => p.data.tags.some(tag => post.data.tags.includes(tag)))
  .slice(0, 3);

const title = post.data.title;
const description = post.data.description;
---

<LayoutRedesign title={title} description={description}>
  <div class="min-h-screen bg-bg-dark text-text-light">
    
    <Header client:load currentPath={Astro.url.pathname} />
    <GridBackground client:only="react" />
    
    <div class="pt-20">
      
      <!-- Article Header -->
      <article class="relative py-12">
        <div class="container mx-auto px-4 relative z-10">
          
          <!-- Back Button -->
          <a 
            href="/blog-redesign"
            class="inline-flex items-center gap-2 text-neon-cyan hover:text-neon-magenta transition-colors mb-8"
          >
            <ArrowLeft className="w-4 h-4" />
            Retour au blog
          </a>

          <!-- Article Meta -->
          <div class="max-w-4xl mx-auto">
            
            <!-- Tags -->
            <div class="flex flex-wrap gap-2 mb-4">
              {post.data.tags.map((tag) => (
                <a
                  href={`/blog-redesign/tags/${tag}`}
                  class="px-3 py-1 text-sm rounded-full bg-neon-cyan/10 border border-neon-cyan/30 text-neon-cyan hover:bg-neon-cyan/20 transition-all"
                >
                  #{tag}
                </a>
              ))}
            </div>

            <!-- Title -->
            <h1 class="text-4xl md:text-5xl lg:text-6xl mb-6 font-bold leading-tight">
              <span class="bg-gradient-to-r from-neon-cyan via-neon-magenta to-neon-cyan bg-clip-text text-transparent">
                {post.data.title}
              </span>
            </h1>

            <!-- Description -->
            <p class="text-xl text-text-muted mb-6 leading-relaxed">
              {post.data.description}
            </p>

            <!-- Metadata -->
            <div class="flex flex-wrap gap-6 text-sm text-text-muted mb-8 pb-8 border-b border-neon-cyan/20">
              <div class="flex items-center gap-2">
                <User className="w-4 h-4 text-neon-cyan" />
                <span>{post.data.author}</span>
              </div>
              <div class="flex items-center gap-2">
                <Calendar className="w-4 h-4 text-neon-cyan" />
                <span>{formatDate(post.data.pubDate)}</span>
              </div>
              {post.data.readingTime && (
                <div class="flex items-center gap-2">
                  <Clock className="w-4 h-4 text-neon-cyan" />
                  <span>{post.data.readingTime} min de lecture</span>
                </div>
              )}
            </div>

            <!-- Featured Image -->
            {post.data.image && (
              <div class="mb-12 rounded-2xl overflow-hidden">
                <img
                  src={post.data.image.url}
                  alt={post.data.image.alt}
                  class="w-full h-auto"
                  loading="eager"
                />
              </div>
            )}

            <!-- Article Content (Prose) -->
            <div class="prose prose-invert prose-cyan max-w-none
              prose-headings:text-text-light
              prose-h1:text-4xl prose-h1:font-bold prose-h1:mb-6
              prose-h2:text-3xl prose-h2:font-bold prose-h2:mb-4 prose-h2:mt-12 prose-h2:text-neon-cyan
              prose-h3:text-2xl prose-h3:font-semibold prose-h3:mb-3 prose-h3:mt-8 prose-h3:text-neon-magenta
              prose-p:text-text-muted prose-p:leading-relaxed prose-p:mb-4
              prose-a:text-neon-cyan prose-a:no-underline hover:prose-a:text-neon-magenta
              prose-strong:text-neon-cyan prose-strong:font-bold
              prose-ul:text-text-muted prose-ul:mb-4
              prose-ol:text-text-muted prose-ol:mb-4
              prose-li:mb-2
              prose-blockquote:border-l-4 prose-blockquote:border-neon-magenta prose-blockquote:pl-4 prose-blockquote:italic prose-blockquote:text-text-muted
              prose-code:text-neon-cyan prose-code:bg-bg-dark-accent prose-code:px-2 prose-code:py-1 prose-code:rounded
              prose-pre:bg-bg-dark-accent prose-pre:border prose-pre:border-neon-cyan/20 prose-pre:rounded-xl
              prose-table:border prose-table:border-neon-cyan/20 prose-table:rounded-lg
              prose-th:bg-bg-dark-accent prose-th:text-neon-cyan prose-th:font-bold prose-th:p-3
              prose-td:p-3 prose-td:border-t prose-td:border-neon-cyan/10
              prose-img:rounded-xl prose-img:my-8
            ">
              <Content />
            </div>

            <!-- Article Footer -->
            <div class="mt-12 pt-8 border-t border-neon-cyan/20">
              <div class="flex flex-wrap gap-2">
                <span class="text-text-muted">Tags :</span>
                {post.data.tags.map((tag) => (
                  <a
                    href={`/blog-redesign/tags/${tag}`}
                    class="px-3 py-1 text-sm rounded-full bg-neon-magenta/10 border border-neon-magenta/30 text-neon-magenta hover:bg-neon-magenta/20 transition-all"
                  >
                    #{tag}
                  </a>
                ))}
              </div>
            </div>

          </div>
        </div>
      </article>

      <!-- Related Articles -->
      {relatedPosts.length > 0 && (
        <section class="relative py-12 bg-gradient-to-b from-transparent to-bg-dark-accent">
          <div class="container mx-auto px-4 relative z-10">
            <h2 class="text-3xl font-bold mb-8 text-center">
              <span class="bg-gradient-to-r from-neon-cyan to-neon-magenta bg-clip-text text-transparent">
                Articles Similaires
              </span>
            </h2>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 max-w-6xl mx-auto">
              {relatedPosts.map((relatedPost) => (
                <article class="group relative">
                  <div class="absolute inset-0 bg-gradient-to-r from-neon-cyan to-neon-magenta rounded-xl opacity-0 group-hover:opacity-10 transition-opacity duration-300 blur-xl" />
                  
                  <a href={`/blog-redesign/${relatedPost.slug}`} class="block relative h-full p-5 rounded-xl bg-bg-dark/40 backdrop-blur-md border border-neon-cyan/20 group-hover:border-neon-cyan/40 transition-all">
                    
                    {relatedPost.data.image && (
                      <div class="mb-3 rounded-lg overflow-hidden">
                        <img
                          src={relatedPost.data.image.url}
                          alt={relatedPost.data.image.alt}
                          class="w-full h-40 object-cover group-hover:scale-105 transition-transform duration-300"
                          loading="lazy"
                        />
                      </div>
                    )}

                    <h3 class="text-lg font-bold text-text-light mb-2 group-hover:text-neon-cyan transition-colors line-clamp-2">
                      {relatedPost.data.title}
                    </h3>

                    <p class="text-text-muted text-sm mb-3 line-clamp-2">
                      {relatedPost.data.description}
                    </p>

                    <div class="flex items-center gap-2 text-neon-magenta text-sm font-medium">
                      Lire l'article
                      <ArrowRight className="w-4 h-4 group-hover:translate-x-1 transition-transform" />
                    </div>
                  </a>
                </article>
              ))}
            </div>
          </div>
        </section>
      )}

    </div>

    <Footer />

  </div>
</LayoutRedesign>
